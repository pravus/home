#!/bin/bash

ssh_agent_env="$HOME/.ssh/ssh-agent.env"

function agent_env_is_valid() {
  if [[ -n "$SSH_AGENT_PID" && -n "$SSH_AUTH_SOCK" ]]; then
    pgrep -u "$UID" ssh-agent | grep -E "^$SSH_AGENT_PID\$" &>/dev/null \
      && return 0
  fi
  return 1
}


if agent_env_is_valid; then
  exit 0
fi

if [[ -f "$ssh_agent_env" ]]; then
  . "$ssh_agent_env"
  if agent_env_is_valid; then
    exit 0
  fi
fi

eval "$(ssh-agent -s)" >/dev/null || exit 1

cat <<EOT >"$ssh_agent_env"
# !(@) ssh-agent.env

SSH_AUTH_SOCK=${SSH_AUTH_SOCK}
export SSH_AUTH_SOCK

SSH_AGENT_PID=${SSH_AGENT_PID}
export SSH_AGENT_PID
EOT

exit 0
