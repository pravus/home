#!/bin/bash

ssh_agent_env="$HOME/.local/var/ssh-agent.env"

function agent_env_is_valid() {
  if [[ -n "$SSH_AGENT_PID" && -n "$SSH_AUTH_SOCK" ]]; then
    pgrep -u "$UID" ssh-agent | grep -E "^$SSH_AGENT_PID\$" &>/dev/null \
      && return 0
  fi
  return 1
}


if agent_env_is_valid; then
  #echo "ssh-agent already running"
  exit 0
fi

if [[ -f "$ssh_agent_env" ]]; then
  . "$ssh_agent_env"
  if agent_env_is_valid; then
    #echo "ssh-agent env loaded"
    exit 0
  fi
fi

#echo "starting new ssh agent"
eval "$(ssh-agent)"

mkdir -p "$(dirname ${ssh_agent_env})"
cat <<EOT >"$ssh_agent_env"
# !(@) ssh-agent.env

SSH_AUTH_SOCK=${SSH_AUTH_SOCK}
export SSH_AUTH_SOCK

SSH_AGENT_PID=${SSH_AGENT_PID}
export SSH_AGENT_PID
EOT
